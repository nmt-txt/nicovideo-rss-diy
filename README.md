# Niconico RSS DYI

## 設定

config.jsonに記述し、docker-compose.yml内で`/config/config.json`へとバインドマウントする。

記述例:

```json
{
    "searchQueries": [
        {"query": "VOCALOID"},
        {"query": "ソフトウェアトーク車載 OR ソフトウェアトーク旅行"},
    ],
    "log": "info"
}
```

この場合`VOCALOID` と `ソフトウェアトーク車載 OR ソフトウェアトーク旅行`の2つで検索を行い結果を混ぜた上で、最新順200件をフィードに表示する。検索タグの数に上限はないものの1つ増やせば1分[更新作業が長くなる](#制限)(おそらくフィードが空な起動直後しか気にならないと思われるが)。  
logの部分は任意。infoと指定した場合はinfo以上のログのみ出力される(error > info > debug. 省略時: info)

## 起動・終了

起動: `$ docker compose up -d`  
RSSフィードは`/`で取得できる。(例:`http://[マシンIPアドレス]:2525/`)

終了: `$ docker compose down`

## 制限

- フィードに載る動画は最大200件まで
- タグ完全一致検索で一致したもののみフィードに載る
- フィードの更新は15分ごとに開始される。更新には以下の時間が必要となり全て完了してからRSSが書き換わる
  - 検索1件ごとに1分 (検索APIリクエスト間隔)
  - 動画1本ごとに1秒 (サムネイル情報リクエスト間隔、取得済みは除外のため最大200秒,最小0秒)
  - 各リクエストが返ってくるまでの時間
- 動画は**1日前**～1年前のものに限られる
  - 利用するAPIのデータは05:00時点のもので固定されリアルタイムに更新されないため([後述](#フィードに載る動画について))

### フィードに載る動画について

利用する[スナップショット検索API v2](https://site.nicovideo.jp/search-api-docs/snapshot)が提供するデータの制限として:

- データは1日1回更新
  - リアルタイムではない
- 参照できるデータはAM 5:00時点のもの
  - 実際のところそのデータが得られるようになるのは約2時間後のAM 7:00頃のようである

がある。  これのために本ソフトウェアがAPIから取得できる動画は05:00までのものに限られ、リアルタイムに最新動画を載せることは不可能である。  
そのため意図的に24時間前の日時を指定してデータを取得・RSS生成することでフィードがリアルタイムに更新されているかのように見せかけている。最新動画情報を文字通りリアルタイムで得たいという用途でこのソフトウェアを利用することは**できない**。  

また、前述の通りデータは05:00までだがそのデータが利用できるようになるのは07:00頃のようであるため5時から7時頃まではフィードが更新されない。

```plaintext
例: 18日の下記各時刻に本ソフトがフィードを生成する場合(24時間表記)
#           [データは17日05:00までが存在]
- 18日04:00 -> 17日04:00までのデータで生成
- 18日05:00 -> 17日05:00まで
- 18日06:00 -> 17日05:00まで ←6時のデータはまだ存在しない
# 18日07:00 [データ更新!、データは18日05:00までが存在]
- 18日07:00 -> 17日07:00まで
```

## 不足

- API検索時のfiltersの指定を可能に
  - 特にjsonFilterにより投稿者を指定したフィードも可能になる
    - フォロー上限人数を超えた場合、RSSで疑似フォローを行う手法があったようなので
- フィードへの通知を抑制するトグル
  - エラーが発生した場合などはフィードへ通知を流すようにしているが場合によっては不便かもしれない
- コンフィグのホットリロード

## ビルド

外部パッケージを使用していないため

`$ go build main.go`

Dockerを使用する場合はビルドを忘れずに。

イメージビルド＆実行: `$ docker compose up -d --build`
ビルドのみ: `docker build -t nicovideo-rss-diy ./`

---

`go build`によって.exeなどのバイナリファイルを生成し、Dockerを使用せず直接起動し利用することも可能なはずである。  
その際は起動オプションとしてconfigファイルを配置するディレクトリ絶対パスを与えることが必要となる。  
例: `./main.exe "C:\Users\XXX\Desktop\nrd"` (デスクトップ内nrdフォルダ内にconfig.jsonを配置する場合)
